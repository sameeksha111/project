<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Dashboard - PHCS</title>
  <link rel="stylesheet" href="../public/css/style.css">
  <link rel="stylesheet" href="../public/css/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-paw"></i> PHCS</h2>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="#dashboard" class="active"><i class="fas fa-chart-line"></i> My Dashboard</a></li>
          <li><a href="#my-cases"><i class="fas fa-folder"></i> My Cases</a></li>
          <li><a href="#all-cases"><i class="fas fa-boxes"></i> All Cases</a></li>
          <li><a href="#create-case"><i class="fas fa-plus-circle"></i> Create Case</a></li>
          <li><a href="#logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="search-bar">
          <input type="text" id="globalSearch" placeholder="Search your cases...">
          <i class="fas fa-search"></i>
        </div>
        <div class="top-bar-right">
          <button id="notificationBell" class="btn-icon">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationCount">0</span>
          </button>
          <div class="user-menu">
            <img src="https://via.placeholder.com/40" alt="User Avatar">
            <span id="userName">Staff</span>
          </div>
        </div>
      </div>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        <!-- KPI Cards -->
        <section class="kpi-cards">
          <div class="card kpi-card">
            <div class="card-icon bg-blue">
              <i class="fas fa-cases"></i>
            </div>
            <div class="card-content">
              <h3>My Cases</h3>
              <p class="kpi-value" id="myCasesCount">0</p>
            </div>
          </div>

          <div class="card kpi-card">
            <div class="card-icon bg-yellow">
              <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="card-content">
              <h3>In Progress</h3>
              <p class="kpi-value" id="inProgressCount">0</p>
            </div>
          </div>

          <div class="card kpi-card">
            <div class="card-icon bg-green">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="card-content">
              <h3>Resolved</h3>
              <p class="kpi-value" id="resolvedCount">0</p>
            </div>
          </div>

          <div class="card kpi-card">
            <div class="card-icon bg-orange">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="card-content">
              <h3>High Priority</h3>
              <p class="kpi-value" id="highPriorityCount">0</p>
            </div>
          </div>
        </section>

        <!-- My Cases Section -->
        <section class="card">
          <div class="section-header">
            <h3>My Assigned Cases</h3>
            <button class="btn btn-primary" onclick="filterCases('open')">Filter</button>
          </div>
          
          <div class="cases-grid" id="myCasesGrid">
            <p>Loading cases...</p>
          </div>
        </section>

        <!-- Recently Updated -->
        <section class="card">
          <h3>Recently Updated Cases</h3>
          <div class="cases-list" id="recentlyUpdatedList">
            <p>Loading...</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Quick Action Modal -->
  <div id="quickActionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Quick Actions</h2>
      <div class="quick-action-buttons">
        <button class="btn btn-success" onclick="markAsResolved()"><i class="fas fa-check"></i> Mark Resolved</button>
        <button class="btn btn-info" onclick="changeStatus()"><i class="fas fa-sync"></i> Change Status</button>
        <button class="btn btn-warning" onclick="addQuickNote()"><i class="fas fa-sticky-note"></i> Add Note</button>
      </div>
    </div>
  </div>

  <script src="../public/js/app.js"></script>
  <script src="../public/js/api.js"></script>
  <script>
    let currentCaseId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const user = JSON.parse(localStorage.getItem('user'));
      document.getElementById('userName').textContent = user.fullName;

      loadMyCases();
      loadNotifications();
    });

    async function loadMyCases() {
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const response = await apiCall(`/api/cases?assignedTo=${user.id}`, 'GET');
        
        const grid = document.getElementById('myCasesGrid');
        grid.innerHTML = '';

        if (response.cases.length === 0) {
          grid.innerHTML = '<p>No cases assigned to you yet.</p>';
          document.getElementById('myCasesCount').textContent = '0';
          return;
        }

        document.getElementById('myCasesCount').textContent = response.cases.length;

        let inProgress = 0, resolved = 0, highPriority = 0;

        response.cases.forEach(caseItem => {
          if (caseItem.status === 'in-progress') inProgress++;
          if (caseItem.status === 'resolved') resolved++;
          if (caseItem.priority === 'high') highPriority++;

          const caseCard = `
            <div class="case-card" onclick="viewCase('${caseItem._id}')">
              <div class="card-header">
                <h4>${caseItem.petName}</h4>
                <span class="badge badge-${caseItem.priority}">${caseItem.priority}</span>
              </div>
              <div class="card-body">
                <p><strong>Owner:</strong> ${caseItem.ownerName}</p>
                <p><strong>Issue:</strong> ${caseItem.issueType}</p>
                <p><strong>Status:</strong> <span class="badge badge-${caseItem.status}">${caseItem.status}</span